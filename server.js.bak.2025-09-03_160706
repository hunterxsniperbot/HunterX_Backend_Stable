import express from 'express';
import bodyParser from 'body-parser';

const app = express();
app.use(bodyParser.json());

// Health mínimo
app.get('/api/healthz', (_req, res)=> res.json({ ok:true, ts: Date.now() }));

// STATUS básico para no romper si faltan exports internos
app.get('/api/autosniper/status', async (_req, res) => {
  try {
    let summary = null;
    try {
      const st = await import('./src/services/state.js');
      summary = st.getWalletSummary ? await st.getWalletSummary()
               : (st.getState ? await st.getState() : null);
    } catch {}
    res.json(summary || { ok:true, mode:'demo', autosniper:false });
  } catch (e) {
    res.status(500).json({ ok:false, error:String(e) });
  }
});

// Un solo listen
const PORT = Number(process.env.API_PORT || process.env.PORT || 3000);
app.listen(PORT, '0.0.0.0', () => {
  console.log(`🌐 API escuchando en http://0.0.0.0:${PORT}`);
});
